<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Labelle — Order Details</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Jost:wght@300;400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --cream: #f9f4ee;
      --warm-white: #fdf9f5;
      --gold: #c9a96e;
      --gold-light: #e8d5b0;
      --dark: #1a1410;
      --muted: #8a7968;
      --border: rgba(201,169,110,0.25);
      --panel-bg: #fff8f2;
    }

    html { scroll-behavior: smooth; }
    body {
      font-family: 'Jost', sans-serif;
      background: var(--warm-white);
      color: var(--dark);
      overflow-x: hidden;
      min-height: 100vh;
    }

    /* ── NAVBAR ── */
    nav {
      position: fixed; top: 0; left: 0; right: 0; z-index: 100;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 5vw; height: 72px;
      background: rgba(253,249,245,0.92);
      backdrop-filter: blur(14px);
      border-bottom: 1px solid var(--border);
    }
    .nav-logo { font-family: 'Cormorant Garamond', serif; font-size: 1.7rem; font-weight: 600; letter-spacing: 0.12em; color: var(--dark); text-decoration: none; }
    .nav-logo span { color: var(--gold); }
    .nav-links { display: flex; gap: 2.4rem; list-style: none; }
    .nav-links a { text-decoration: none; font-size: 0.78rem; font-weight: 400; letter-spacing: 0.14em; text-transform: uppercase; color: var(--muted); transition: color 0.2s; }
    .nav-links a:hover { color: var(--gold); }
    .nav-actions { display: flex; align-items: center; gap: 1.4rem; }
    .nav-actions a { text-decoration: none; font-size: 0.75rem; letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted); transition: color 0.2s; }
    .nav-actions a:hover { color: var(--dark); }

    /* ── PAGE ── */
    .page-wrapper { padding-top: 72px; min-height: 100vh; }

    .page-banner {
      background: linear-gradient(135deg, #1a1410 0%, #2e1f10 40%, #4a2e18 70%, #1a1410 100%);
      padding: 3.5rem 5vw 3rem; position: relative; overflow: hidden;
    }
    .page-banner::before {
      content: ''; position: absolute; top: -60%; right: -5%; width: 50vw; height: 50vw;
      border-radius: 50%; background: radial-gradient(circle, rgba(201,169,110,0.15) 0%, transparent 65%); pointer-events: none;
    }
    .banner-inner { position: relative; z-index: 1; display: flex; align-items: flex-end; justify-content: space-between; flex-wrap: wrap; gap: 1rem; }
    .banner-eyebrow { font-size: 0.68rem; letter-spacing: 0.3em; text-transform: uppercase; color: var(--gold); margin-bottom: 0.6rem; }
    .banner-title { font-family: 'Cormorant Garamond', serif; font-size: clamp(2rem, 4vw, 3rem); font-weight: 300; color: var(--cream); line-height: 1.1; }
    .banner-title em { font-style: italic; color: var(--gold-light); }
    .banner-order-id { font-size: 0.72rem; letter-spacing: 0.18em; color: rgba(249,244,238,0.4); text-transform: uppercase; padding: 0.4rem 1rem; border: 1px solid rgba(201,169,110,0.25); }

    /* ── LAYOUT ── */
    .profile-layout {
      display: grid; grid-template-columns: 280px 1fr;
      gap: 2rem; padding: 2.5rem 5vw 4rem;
      max-width: 1200px; margin: 0 auto; align-items: start;
    }

    /* ── SIDEBAR ── */
    .sidebar { position: sticky; top: 90px; animation: fadeUp 0.8s cubic-bezier(0.22,1,0.36,1) both; }
    @keyframes fadeUp { from { opacity:0; transform:translateY(24px); } to { opacity:1; transform:translateY(0); } }
    .sidebar-card { background: var(--panel-bg); border: 1px solid var(--border); overflow: hidden; }
    .sidebar-avatar-area { background: linear-gradient(145deg,#1a1410,#2e1f10); padding: 2.2rem 1.5rem 1.8rem; text-align: center; position: relative; }
    .sidebar-avatar-area::after { content:''; position:absolute; bottom:-1px; left:0; right:0; height:2px; background: linear-gradient(to right, transparent, var(--gold), transparent); }
    .avatar-ring { width:96px; height:96px; border-radius:50%; border:2px solid var(--gold); padding:3px; display:inline-block; margin-bottom:1rem; }
    .avatar-ring img { width:100%; height:100%; border-radius:50%; object-fit:cover; display:block; }
    .sidebar-name { font-family:'Cormorant Garamond',serif; font-size:1.3rem; font-weight:400; color:var(--cream); margin-bottom:0.25rem; }
    .sidebar-email { font-size:0.72rem; color:rgba(249,244,238,0.45); letter-spacing:0.04em; word-break:break-all; }
    .sidebar-email a { color:inherit; text-decoration:none; }

    /* back button area */
    .sidebar-back { padding: 1.2rem 1.4rem; }
    .btn-back {
      display: inline-flex; align-items: center; gap: 0.6rem;
      text-decoration: none; font-size: 0.75rem; letter-spacing: 0.14em;
      text-transform: uppercase; color: var(--muted);
      padding: 0.7rem 1.2rem; border: 1px solid var(--border);
      background: transparent; cursor: pointer;
      transition: background 0.2s, color 0.2s, border-color 0.2s;
      width: 100%; justify-content: center;
    }
    .btn-back:hover { background: rgba(201,169,110,0.08); border-color: var(--gold); color: var(--dark); }
    .btn-back i { font-size: 0.8rem; color: var(--gold); }

    /* ── MAIN ── */
    .main-content { display:flex; flex-direction:column; gap:1.8rem; animation:fadeUp 0.8s 0.12s cubic-bezier(0.22,1,0.36,1) both; }

    /* ── TWO-COL DETAIL LAYOUT ── */
    .detail-grid { display:grid; grid-template-columns: 1fr 340px; gap:1.8rem; align-items:start; }

    /* ── PANELS ── */
    .content-panel { background:var(--panel-bg); border:1px solid var(--border); overflow:hidden; }
    .panel-header { padding:1.4rem 2rem; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap; }
    .panel-eyebrow { font-size:0.65rem; letter-spacing:0.25em; text-transform:uppercase; color:var(--gold); margin-bottom:0.2rem; }
    .panel-title { font-family:'Cormorant Garamond',serif; font-size:1.5rem; font-weight:300; color:var(--dark); }
    .gold-divider { height:1px; background:linear-gradient(to right, transparent, var(--gold), transparent); }

    /* ── ITEM CARDS ── */
    .item-list { display:flex; flex-direction:column; }
    .order-item { display:grid; grid-template-columns:90px 1fr auto; gap:1.2rem; align-items:start; padding:1.4rem 2rem; border-bottom:1px solid var(--border); transition:background 0.2s; }
    .order-item:last-child { border-bottom:none; }
    .order-item:hover { background:rgba(201,169,110,0.03); }

    .item-img-wrap {
      width:90px; height:90px; overflow:hidden;
      border:1px solid var(--border);
      background: linear-gradient(145deg, #e8ddd1, #d4c4b0);
      flex-shrink:0;
    }
    .item-img-wrap img { width:100%; height:100%; object-fit:cover; display:block; }

    .item-info { display:flex; flex-direction:column; gap:0.3rem; }
    .item-name { font-family:'Cormorant Garamond',serif; font-size:1.1rem; font-weight:400; color:var(--dark); }
    .item-meta { font-size:0.75rem; color:var(--muted); font-weight:300; }

    .item-status-tag {
      display:inline-flex; align-items:center; gap:0.3rem;
      margin-top:0.4rem;
      font-size:0.65rem; letter-spacing:0.12em; text-transform:uppercase;
      padding:0.25rem 0.65rem;
    }
    .tag-cancelled { background:rgba(192,57,43,0.08); color:#c0392b; border:1px solid rgba(192,57,43,0.2); }
    .tag-returned  { background:rgba(138,121,104,0.1); color:var(--muted); border:1px solid var(--border); }
    .tag-failed    { background:rgba(192,57,43,0.06); color:#c0392b; border:1px dashed rgba(192,57,43,0.3); font-size:0.65rem; }
    .tag-coupon    { background:rgba(201,169,110,0.1); color:var(--muted); border:1px dashed var(--border); font-size:0.65rem; }

    .item-cancel-btn {
      background:transparent; border:1px solid var(--border); color:var(--muted);
      font-family:'Jost',sans-serif; font-size:0.68rem; letter-spacing:0.1em; text-transform:uppercase;
      padding:0.3rem 0.9rem; cursor:pointer; display:inline-flex; align-items:center; gap:0.35rem;
      transition:background 0.2s, border-color 0.2s, color 0.2s; margin-top:0.4rem; width:fit-content;
    }
    .item-cancel-btn:hover { background:rgba(192,57,43,0.07); border-color:#c0392b; color:#c0392b; }

    .item-prices { display:flex; flex-direction:column; align-items:flex-end; gap:0.4rem; min-width:100px; }
    .price-line { display:flex; flex-direction:column; align-items:flex-end; }
    .price-label { font-size:0.62rem; letter-spacing:0.15em; text-transform:uppercase; color:var(--muted); }
    .price-val { font-family:'Cormorant Garamond',serif; font-size:1.1rem; font-weight:600; color:var(--dark); }
    .price-qty { font-size:0.78rem; color:var(--muted); font-weight:300; }

    /* ── INVOICE BUTTON ── */
    .invoice-row { padding:1.2rem 2rem; border-top:1px solid var(--border); background:rgba(249,244,238,0.4); display:flex; justify-content:flex-end; }
    .btn-invoice {
      padding:0.7rem 1.8rem; background:var(--gold); color:var(--dark); border:none;
      font-family:'Jost',sans-serif; font-size:0.75rem; letter-spacing:0.16em; text-transform:uppercase;
      font-weight:500; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; gap:0.5rem;
      transition:background 0.2s, transform 0.2s;
    }
    .btn-invoice:hover { background:var(--gold-light); transform:translateY(-1px); }

    /* ── ORDER SUMMARY PANEL ── */
    .summary-sticky { position:sticky; top:90px; }

    .summary-rows { padding:1.4rem 2rem; display:flex; flex-direction:column; gap:0; }
    .summary-row { display:flex; justify-content:space-between; align-items:center; padding:0.75rem 0; border-bottom:1px solid var(--border); }
    .summary-row:last-child { border-bottom:none; }
    .s-label { font-size:0.72rem; letter-spacing:0.1em; text-transform:uppercase; color:var(--muted); }
    .s-val { font-size:0.85rem; color:var(--dark); font-weight:400; text-align:right; }
    .s-val.gold-val { font-family:'Cormorant Garamond',serif; font-size:1.2rem; font-weight:600; color:var(--gold); }

    .summary-total { padding:1rem 2rem; background:linear-gradient(135deg,#1a1410,#2e1f10); display:flex; justify-content:space-between; align-items:center; }
    .total-label { font-size:0.7rem; letter-spacing:0.25em; text-transform:uppercase; color:rgba(249,244,238,0.5); }
    .total-val { font-family:'Cormorant Garamond',serif; font-size:1.6rem; font-weight:600; color:var(--gold-light); }

    /* status badge inside summary */
    .status-badge { display:inline-flex; align-items:center; gap:0.35rem; padding:0.3rem 0.8rem; font-size:0.65rem; letter-spacing:0.12em; text-transform:uppercase; font-weight:500; }
    .status-badge::before { content:''; width:6px; height:6px; border-radius:50%; display:inline-block; }
    .status-delivered { background:rgba(39,174,96,0.1); color:#27ae60; border:1px solid rgba(39,174,96,0.25); }
    .status-delivered::before { background:#27ae60; }
    .status-pending { background:rgba(201,169,110,0.12); color:#a07840; border:1px solid rgba(201,169,110,0.3); }
    .status-pending::before { background:var(--gold); }
    .status-cancelled { background:rgba(192,57,43,0.08); color:#c0392b; border:1px solid rgba(192,57,43,0.2); }
    .status-cancelled::before { background:#c0392b; }
    .status-returned { background:rgba(138,121,104,0.1); color:var(--muted); border:1px solid var(--border); }
    .status-returned::before { background:var(--muted); }

    /* ── SHIPPING PANEL ── */
    .shipping-block { padding:1.4rem 2rem; }
    .shipping-name { font-family:'Cormorant Garamond',serif; font-size:1.1rem; font-weight:400; color:var(--dark); margin-bottom:0.5rem; }
    .shipping-line { font-size:0.8rem; color:var(--muted); font-weight:300; line-height:1.8; }
    .shipping-line i { color:var(--gold); margin-right:0.4rem; font-size:0.75rem; }

    /* ── RESPONSIVE ── */
    @media (max-width:1050px) { .detail-grid { grid-template-columns:1fr; } .summary-sticky { position:static; } }
    @media (max-width:900px)  { .profile-layout { grid-template-columns:1fr; } .sidebar { position:static; } }
    @media (max-width:600px)  {
      .nav-links { display:none; }
      .order-item { grid-template-columns:70px 1fr; }
      .item-prices { grid-column:1/-1; flex-direction:row; justify-content:space-between; }
    }
  </style>
</head>
<body>

<!-- ── NAVBAR ── -->
<nav>
  <a href="/" class="nav-logo">La<span>belle</span></a>
  <ul class="nav-links">
    <li><a href="/">Home</a></li>
    <li><a href="/shop">Shop</a></li>
    <li><a href="#">Contact</a></li>
  </ul>
  <div class="nav-actions">
    <% if (typeof user !== 'undefined' && user) { %>
      <a href="#">Favourites</a>
      <a href="/user-profile">Profile</a>
    <% } else { %>
      <a href="/login">Login</a>
    <% } %>
  </div>
</nav>

<div class="page-wrapper">

  <!-- ── BANNER ── -->
  <div class="page-banner">
    <div class="banner-inner">
      <div>
        <p class="banner-eyebrow">Account / Orders</p>
        <h1 class="banner-title">Order <em>Details</em></h1>
      </div>
      <span class="banner-order-id">#<%= order.orderId %></span>
    </div>
  </div>

  <!-- ── LAYOUT ── -->
  <div class="profile-layout">


    

    <!-- ── MAIN ── -->
    <main class="main-content">
      <div class="detail-grid">

        <!-- LEFT: Items -->
        <div>
          <div class="content-panel">
            <div class="panel-header">
              <div>
                <p class="panel-eyebrow">Items Ordered</p>
                <h2 class="panel-title">Your Fragrances</h2>
              </div>
              <span style="font-size:0.75rem;color:var(--muted);"><%= order.orderedItems.length %> item<%= order.orderedItems.length !== 1 ? 's' : '' %></span>
            </div>

            <div class="item-list">
              <% order.orderedItems.forEach(function(item) { %>
              <div class="order-item">
                <!-- Image -->
                <div class="item-img-wrap">
                  <img src="<%= item.variantId.productId.images[0] %>" alt="<%= item.variantId.productId.name %>">
                </div>

                <!-- Info -->
                <div class="item-info">
                  <div class="item-name"><%= item.variantId.productId.name %></div>
                  <div class="item-meta">Gender: <%= item.variantId.productId.gender %></div>

                  <% if (!order.discount > 0 && order.paymentStatus == 'true') { %>
                    <% if (!item.isCancelled) { %>
                      <button class="item-cancel-btn"
                        data-status="<%= order.status %>"
                        data-product-id="<%= item.variantId._id %>"
                        onclick="confirmAction(this)">
                        <i class="fa fa-<%= order.status === 'Delivered' ? 'rotate-left' : 'xmark' %>"></i>
                        <%= order.status === 'Delivered' ? 'Return' : 'Cancel' %>
                      </button>
                    <% } else { %>
                      <span class="item-status-tag <%= order.status === 'Returned' ? 'tag-returned' : 'tag-cancelled' %>">
                        <i class="fa fa-<%= order.status === 'Returned' ? 'rotate-left' : 'xmark' %>"></i>
                        <%= order.status === 'Returned' ? 'Returned' : 'Cancelled' %>
                      </span>
                    <% } %>
                  <% } else if (order.paymentStatus == 'false') { %>
                    <span class="item-status-tag tag-failed">
                      <i class="fa fa-triangle-exclamation"></i> Payment Failed
                    </span>
                  <% } else if (order.discount > 0) { %>
                    <span class="item-status-tag tag-coupon">
                      <i class="fa fa-tag"></i> Coupon applied — item cancellation unavailable
                    </span>
                  <% } %>
                </div>

                <!-- Prices -->
                <div class="item-prices">
                  <div class="price-line">
                    <span class="price-label">Price</span>
                    <span class="price-val">₹<%= item.price.toFixed(2) %></span>
                  </div>
                  <div class="price-line" style="align-items:flex-end;">
                    <span class="price-label">Qty</span>
                    <span class="price-qty"><%= item.quantity %></span>
                  </div>
                  <div class="price-line" style="align-items:flex-end; padding-top:0.4rem; border-top:1px solid var(--border);">
                    <span class="price-label">Total</span>
                    <span class="price-val">₹<%= (item.price * item.quantity).toFixed(2) %></span>
                  </div>
                </div>
              </div>
              <% }); %>
            </div>

            <% if (order.status === 'Delivered') { %>
            <div class="invoice-row">
              <a href="/download-invoice/<%= order._id %>" class="btn-invoice">
                <i class="fa fa-file-arrow-down"></i> Download Invoice
              </a>
            </div>
            <% } %>
          </div>
        </div>

        <!-- RIGHT: Summary + Shipping -->
        <div class="summary-sticky">
  <div class="summary-grid"></div>
          <!-- Order Summary -->
          <div class="content-panel" style="margin-bottom:1.4rem;">
            <div class="panel-header">
              <div>
                <p class="panel-eyebrow">Breakdown</p>
                <h2 class="panel-title">Order Summary</h2>
              </div>
            </div>

            <div class="summary-rows">
              <div class="summary-row">
                <span class="s-label">Order Date</span>
                <span class="s-val"><%= order.date.toLocaleDateString('en-IN', {day:'2-digit', month:'short', year:'numeric'}) %></span>
              </div>
              <div class="summary-row">
                <span class="s-label">Subtotal</span>
                <span class="s-val">₹<%= order.cartAmount.toFixed(2) %></span>
              </div>
              <div class="summary-row">
                <span class="s-label">Discount</span>
                <span class="s-val" style="color:#27ae60;">− ₹<%= order.discount.toFixed(2) %></span>
              </div>
              <div class="summary-row">
                <span class="s-label">Payment</span>
                <span class="s-val" style="text-transform:uppercase; font-size:0.78rem; letter-spacing:0.08em;"><%= order.paymentMethod %></span>
              </div>
              <div class="summary-row">
                <span class="s-label">Payment Status</span>
                <span class="s-val">
                  <% if (order.paymentStatus == 'true') { %>
                    <span style="color:#27ae60; font-size:0.78rem;"><i class="fa fa-circle-check" style="margin-right:0.3rem;"></i>Success</span>
                  <% } else { %>
                    <span style="color:#c0392b; font-size:0.78rem;"><i class="fa fa-circle-xmark" style="margin-right:0.3rem;"></i>Failed</span>
                  <% } %>
                </span>
              </div>
              <div class="summary-row">
                <span class="s-label">Order Status</span>
                <span class="s-val">
                  <% if (order.status === 'Delivered') { %><span class="status-badge status-delivered">Delivered</span>
                  <% } else if (order.status === 'Pending') { %><span class="status-badge status-pending">Pending</span>
                  <% } else if (order.status === 'Cancelled') { %><span class="status-badge status-cancelled">Cancelled</span>
                  <% } else if (order.status === 'Returned') { %><span class="status-badge status-returned">Returned</span>
                  <% } %>
                </span>
              </div>
            </div>

            <div class="gold-divider"></div>
            <div class="summary-total">
              <span class="total-label">Total</span>
              <span class="total-val">₹<%= order.totalAmount.toFixed(2) %></span>
            </div>
          </div>

          <!-- Shipping Address -->
          <div class="content-panel">
            <div class="panel-header">
              <div>
                <p class="panel-eyebrow">Delivery</p>
                <h2 class="panel-title">Shipping Address</h2>
              </div>
            </div>
            <div class="shipping-block">
              <div class="shipping-name"><%= order.address.name %></div>
              <div class="shipping-line">
                <i class="fa fa-location-dot"></i>
                <%= order.address.streetAddress || '' %>
                <% if (order.address.landMark) { %>, <%= order.address.landMark %><% } %>
              </div>
              <div class="shipping-line">
                <i class="fa fa-city"></i>
                <%= order.address.city %>, <%= order.address.state %> – <%= order.address.pincode %>
              </div>
              <div class="shipping-line" style="margin-top:0.5rem;">
                <i class="fa fa-phone"></i> <%= order.address.phone %>
              </div>
            </div>
          </div>

        </div><!-- end summary-sticky -->
      </div><!-- end detail-grid -->
    </main>
  </div>
</div>
<script>
  // Active sidebar
  const currentPage = window.location.pathname;
  const pages = { "/user-profile":"profile", "/user-address":"address-book", "/user-order":"order-details", "/user-coupon":"coupon", "/user-wallet":"wallet" };
  for (let p in pages) { if (currentPage === p) { const el = document.getElementById(pages[p]); if(el) el.classList.add('active'); } }

  function confirmAction(element) {
    const status    = element.getAttribute('data-status');
    const productId = element.getAttribute('data-product-id');
    const orderId   = "<%= order._id %>";
    const isReturn  = status === 'Delivered';

    Swal.fire({
      title: isReturn ? 'Return this item?' : 'Cancel this item?',
      text:  isReturn ? 'A return request will be raised for this product.' : 'This item will be cancelled and refunded.',
      icon:  'warning',
      showCancelButton: true,
      confirmButtonColor: '#c9a96e',
      cancelButtonColor:  '#8a7968',
      confirmButtonText:  isReturn ? 'Yes, return it' : 'Yes, cancel it',
      cancelButtonText:   'Keep it'
    }).then(result => {
      if (result.isConfirmed) {
        fetch(`/cancel-single-product/${orderId}/${productId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ actionType: isReturn ? 'return' : 'cancel' })
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            Swal.fire({ title:'Done', text: data.message, icon:'success', confirmButtonColor:'#c9a96e', timer:1800, showConfirmButton:false })
              .then(() => location.reload());
          } else {
            Swal.fire({ title:'Error', text: data.message, icon:'error', confirmButtonColor:'#c9a96e' });
          }
        })
        .catch(() => Swal.fire({ title:'Error', text:'Something went wrong.', icon:'error', confirmButtonColor:'#c9a96e' }));
      }
    });
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>
</html>
