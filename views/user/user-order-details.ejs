<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Labelle</title>
    <link href="https://netdna.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/MaterialDesign-Webfont/5.3.45/css/materialdesignicons.css"
        rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="icon" href="img/core-img/favicon.ico">

    <style>
        body {
            color: #797979;
            background: #f1f3f7;
            font-family: 'Open Sans', sans-serif;
            padding: 0px !important;
            margin: 0px !important;
            font-size: 13px;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -moz-font-smoothing: antialiased;
        }

        .profile-nav,
        .profile-info {
            margin-top: 30px;
        }

        .profile-nav .user-heading {
            background: #fbb710;
            color: #fff;
            border-radius: 4px 4px 0 0;
            -webkit-border-radius: 4px 4px 0 0;
            padding: 30px;
            text-align: center;
        }

        .profile-nav .user-heading.round a {
            border-radius: 50%;
            -webkit-border-radius: 50%;
            border: 10px solid rgba(255, 255, 255, 0.3);
            display: inline-block;
        }

        .profile-nav .user-heading a img {
            width: 112px;
            height: 112px;
            border-radius: 50%;
            -webkit-border-radius: 50%;
        }

        .profile-nav .user-heading h1 {
            font-size: 22px;
            font-weight: 300;
            margin-bottom: 5px;
        }

        .profile-nav .user-heading p {
            font-size: 12px;
        }

        .profile-nav ul {
            margin-top: 1px;
        }

        .profile-nav ul>li {
            border-bottom: 1px solid #ebeae6;
            margin-top: 0;
            line-height: 30px;
        }

        .profile-nav ul>li:last-child {
            border-bottom: none;
        }

        .profile-nav ul>li>a {
            border-radius: 0;
            -webkit-border-radius: 0;
            color: #89817f;
            border-left: 5px solid #fff;
        }

        .profile-nav ul>li>a:hover,
        .profile-nav ul>li>a:focus,
        .profile-nav ul li.active a {
            background: #f8f7f5 !important;
            border-left: 5px solid #fbb710;
            color: #89817f !important;
        }

        .profile-nav ul>li:last-child>a:last-child {
            border-radius: 0 0 4px 4px;
            -webkit-border-radius: 0 0 4px 4px;
        }

        .profile-nav ul>li>a>i {
            font-size: 16px;
            padding-right: 10px;
            color: #bcb3aa;
        }

        /* Navbar Style */
        .navbar {
            background-color: white;
            padding: 10px 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 0px;
        }

        .navbar-links {
            list-style-type: none;
            display: flex;
            justify-content: center;
            padding: 15px 50px;
            margin-left: 420px;
        }

        .navbar-links li {
            margin: 0 20px;
        }

        .navbar-links a {
            text-decoration: none;
            color: black;
            font-size: 14px;
            transition: color 0.3s ease, background-color 0.3s ease;
            padding: 5px 10px;
            border-radius: 4px;
        }

        .navbar-links a:hover {
            color: white;
            background-color: #FBB710;
        }

        /* New Flex Layout Styles */
        .flex-layout-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            width: 100%;
        }

        .products-section {
            flex: 1;
            max-width: 65%;
        }

        .order-summary-section {
            flex: 0 0 35%;
            position: sticky;
            top: 20px;
            align-self: flex-start;
        }

        .card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }

        .card-body {
            padding: 15px;
        }

        .avatar-lg {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
        }

        .product-details {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .product-info {
            flex-grow: 1;
        }

        .quantity-section {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .quantity-section>div {
            flex: 1;
        }

        .form-select {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100px;
        }

        .summary-table {
            width: 100%;
        }

        .summary-table td {
            padding: 8px 0;
        }

        .summary-table td:last-child {
            text-align: right;
        }

        .total-row {
            font-weight: bold;
            border-top: 2px solid #eee;
        }

        .btn-continue-shopping,
        .btn-checkout {
            padding: 8px 15px;
            border-radius: 4px;
            text-decoration: none;
            display: inline-block;
        }

        .btn-continue-shopping {
            color: #666;
        }

        .btn-checkout {
            background: #fbb710;
            color: white;
            float: right;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .flex-layout-container {
                flex-direction: column;
            }

            .products-section,
            .order-summary-section {
                max-width: 100%;
            }

            .order-summary-section {
                position: static;
            }
        }

        @media (max-width: 768px) {
            .navbar-links {
                margin-left: 0;
                justify-content: center;
            }

            .product-details {
                flex-direction: column;
            }

            .quantity-section {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

</head>

<body>
    <nav class="navbar">
        <ul class="navbar-links">
            <li><a href="/">Home</a></li>
            <li><a href="/shop">Shop</a></li>
            <li><a href="#">Contact</a></li>
        </ul>
    </nav>

    <div class="container bootstrap snippets bootdey">
        <div class="row">
            <!-- Sidebar -->
            <div class="profile-nav col-md-3">
                <div class="panel">
                    <div class="user-heading round">
                        <a href="#">
                            <img src="<%= userData.gender === 'male' 
                        ? 'https://www.bootdey.com/img/Content/avatar/avatar2.png' 
                        : userData.gender === 'female' 
                        ? 'https://www.bootdey.com/img/Content/avatar/avatar3.png' 
                        : 'https://via.placeholder.com/150' %>" alt="User Avatar" id="profileAvatar">
                        </a>
                        <h1>
                            <%= userData ? userData.name : 'Guest' %>
                        </h1>
                        <p>
                            <a href="mailto:<%= userData ? userData.email : 'not available' %>">
                                <%= userData ? userData.email : 'Email not available' %>
                            </a>
                        </p>
                    </div>

                    <ul class="nav nav-pills nav-stacked">
                        <li id="profile"><a href="/user-profile"> <i class="fa fa-user"></i> Profile</a></li>
                        <li id="address-book"><a href="/user-address"> <i class="fa fa-address-book"></i> Address
                                Book</a></li>
                        <li id="order-details"><a href="/user-order"> <i class="fa fa-shopping-basket"></i> Order
                                Details</a></li>
                        <li id="coupon"><a href="/user-coupon"> <i class="fa fa-ticket-alt"></i> Coupon</a></li>
                        <li id="wallet"><a href="/user-wallet"> <i class="fa fa-wallet"></i> Wallet</a></li>
                        <% if (typeof user !=='undefined' && user) { %>
                            <li id="logout"><a href="/logout"> <i class="fa fa-sign-out"></i>Logout</a></li>
                            <% } %>
                    </ul>
                </div>
            </div>
            <script>
                const currentPage = window.location.pathname;

                const pages = {
                    "/user-profile": "profile",
                    "/user-address": "address-book",
                    "/user-order": "order-details",
                    "/user-coupon": "coupon",
                    "/user-wallet": "wallet"
                };

                for (let page in pages) {
                    if (currentPage === page) {
                        document.getElementById(pages[page]).classList.add('active');
                    }
                }
            </script>



            <div class="container mt-5">
                <div class="col-md-9">
                    <div class="flex-layout-container">
                        <!-- Products Section -->
                        <div class="products-section">
                            <% order.orderedItems.forEach(item=> { %>
                                <div class="card">
                                    <div class="card-body">
                                        <div class="product-details">
                                            <img src="<%= item.variantId.productId.images[0] %>" alt="Product Image"
                                                class="avatar-lg">
                                            <div class="product-info">
                                                <h5 style="color: black;">
                                                    <%= item.variantId.productId.name %>
                                                </h5>
                                               
                                                <p>Gender: <span>
                                                        <%= item.variantId.productId.gender %>
                                                    </span></p>
                                            </div>
                                            
                                            <div class="flex-shrink-0 ms-2">
                                                <ul class="list-inline mb-0 font-size-16">
                                                    <li class="list-inline-item">
                                                        <% if(!order.discount>0 && order.paymentStatus=='true'){ %>
                                                        <% if (!item.isCancelled ) { %>
                                                            <i class="fa fa-reply" data-status="<%= order.status %>"
                                                                data-product-id="<%= item.variantId._id %>"
                                                                onclick="confirmAction(this)"> cancel</i>
                                                            <% } else { %>
                                                                <span class="text-muted" style="color: red;">
                                                                    <%= order.status==='Returned' ? 'Returned'
                                                                        : 'Cancelled' %>
                                                                </span>
                                                                <% } %>
                                                            <% }else if(order.paymentStatus=='false'){ %>
                                                                <p style="font-size: 8px;">*Payment Failed </p>
                                                            <% }else if(order.discount>0){ %>
                                                                <p style="font-size: 8px;">*single Product can't be canceled for coupon used orders</p>
                                                                <% } %>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>


                                        <div class="quantity-section">
                                            <div>
                                                <p>Price</p>
                                                <h5>₹<%= item.price.toFixed(2) %>
                                                </h5>
                                            </div>
                                            <div>
                                                <p>Quantity</p>
                                                <h5>
                                                    <%= item.quantity %>
                                                </h5>
                                            </div>
                                            <div>
                                                <p>Total</p>
                                                <h5>₹
                                                    <%= item.price*item.quantity  %>
                                                        </span>
                                                </h5>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <% }); %>
                                    <% if(order.status=='Delivered' ){ %>
                                        <a href="/download-invoice/<%= order._id %>"
                                            style="margin-left: 200px; background-color: #fbb710; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                                            Download Invoice</a>
                                        <% } %>
                        </div>

                        <!-- Order Summary Section -->
                        <div class="order-summary-section">
                            <div class="card">
                                <div class="card-body">
                                    <h5>Order Summary <span style="float: right">#<%= order.orderId %></span></h5>
                                    <table class="summary-table">
                                        <tr>
                                            <td>Order Date:</td>
                                            <td>
                                                <%= order.date.toLocaleDateString() %>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Sub Total:</td>
                                            <td>₹<%= (order.cartAmount).toFixed(2) %>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Discount:</td>
                                            <td>- ₹<%= (order.discount).toFixed(2) %>
                                            </td>
                                        </tr>

                                        <tr>
                                            <td>Payment Method:</td>
                                            <td>
                                                <%= order.paymentMethod.toUpperCase() %>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Payment Status:</td>
                                            <td>
                                                <%= order.paymentStatus%>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Order Status:</td>
                                            <td>
                                                <%= order.status %>
                                            </td>
                                        </tr>
                                        <tr class="total-row">
                                            <td>Total:</td>
                                            <td>₹<%= order.totalAmount.toFixed(2) %>
                                            </td>
                                        </tr>
                                    </table>


                                    <div class="shipping-details mt-4">
                                        <h5>Shipping Address</h5>
                                        <p>
                                            <%= order.address.name %>
                                        </p>
                                        <p>
                                            <%= order.address.landMark ? order.address.landMark + ', ' : '' %>
                                        </p>
                                        <p>
                                            <%= order.address.city %>, <%= order.address.state %> - <%=
                                                        order.address.pincode %>
                                        </p>
                                        <p>Phone: <%= order.address.phone %>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        function confirmAction(element) {
            const status = element.getAttribute('data-status');
            const productId = element.getAttribute('data-product-id');
            const orderId = "<%= order._id %>";

            let message = '';
            let actionType = '';
            if (status === 'Pending') {
                message = 'Are you sure you want to cancel this product?';
                actionType = 'cancel';
            } else if (status === 'Delivered') {
                message = 'Are you sure you want to return this product?';
                actionType = 'return';
            }

            Swal.fire({
                title: 'Confirm Action',
                text: message,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, proceed!',
                cancelButtonText: 'No, cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/cancel-single-product/${orderId}/${productId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ actionType })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                Swal.fire(
                                    'Success',
                                    data.message,
                                    'success'
                                );
                                setTimeout(() => {
                                    location.reload();
                                }, 1500);
                            } else {
                                Swal.fire(
                                    'Error',
                                    data.message,
                                    'error'
                                );
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            Swal.fire(
                                'Error',
                                'Something went wrong. Please try again.',
                                'error'
                            );
                        });
                } else {
                    Swal.fire(
                        'Action Canceled',
                        'No changes were made.',
                        'info'
                    );
                }
            });
        }

    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="https://netdna.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script> -->
</body>

</html>